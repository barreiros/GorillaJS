#!/bin/bash -l

SSL={{project.sslenable}}

cp /root/templates/apache-vhost.conf /etc/apache2/sites-available/{{project.domain}}.conf && 
cp -r /root/templates/waiting.html /var/www/html/index.html &&

service php5-fpm restart && service apache2 restart &&

echo 'init' > /var/www/html/gorilla_status.txt &&

cd /var/www/{{project.domain}} &&

if [ -e {{project.srcout}}/config.php ]; then

    # Reemplazo los valores de configuración.

    sed -i '/DB_HOSTNAME/c\define("DB_HOSTNAME", "mysql");' {{project.srcout}}/config.php && 
    sed -i '/DB_USERNAME/c\define("DB_USERNAME", "{{database.username}}");' {{project.srcout}}/config.php && 
    sed -i '/DB_PASSWORD/c\define("DB_PASSWORD", "{{database.password}}");' {{project.srcout}}/config.php && 
    sed -i '/DB_DATABASE/c\define("DB_DATABASE", "{{database.dbname}}");' {{project.srcout}}/config.php && 
    sed -i '/DB_PORT/c\define("DB_PORT", "3306");' {{project.srcout}}/config.php && 

    sed -i '/DB_HOSTNAME/c\define("DB_HOSTNAME", "mysql");' {{project.srcout}}/admin/config.php && 
    sed -i '/DB_USERNAME/c\define("DB_USERNAME", "{{database.username}}");' {{project.srcout}}/admin/config.php && 
    sed -i '/DB_PASSWORD/c\define("DB_PASSWORD", "{{database.password}}");' {{project.srcout}}/admin/config.php && 
    sed -i '/DB_DATABASE/c\define("DB_DATABASE", "{{database.dbname}}");' {{project.srcout}}/admin/config.php &&
    sed -i '/DB_PORT/c\define("DB_PORT", "3306");' {{project.srcout}}/admin/config.php

else

    # Descargo la última versión de OpenCart.

    echo 'Downloading the latest OpenCart official version' > /var/www/html/gorilla_status.txt

    wget --read-timeout=3 -U Mozilla/5.0 -P . -c https://github.com/opencart/opencart/archive/master.zip &&
    unzip master.zip &&
    mv -v opencart-master/upload/* {{project.srcout}}/ &&

    # Configuro la aplicación.

    sed -ie 's/\$db_hostname/"mysql"/g' {{project.srcout}}/install/view/template/install/step_3.tpl &&
    sed -ie 's/\$db_database/"{{database.dbname}}"/g' {{project.srcout}}/install/view/template/install/step_3.tpl &&
    sed -ie 's/\$db_username/"{{database.username}}"/g' {{project.srcout}}/install/view/template/install/step_3.tpl &&
    sed -ie 's/\$db_password/"{{database.password}}"/g' {{project.srcout}}/install/view/template/install/step_3.tpl &&

    mv {{project.srcout}}/config-dist.php {{project.srcout}}/config.php &&
    mv {{project.srcout}}/admin/config-dist.php {{project.srcout}}/admin/config.php &&
    rm -rf master.zip opencart-master &&

    echo $'\nexec("rm -rf /var/www/{{project.domain}}/{{project.srcout}}/install && sed -i \'$ d\' /var/www/{{project.domain}}/{{project.srcout}}/index.php");' >> {{project.srcout}}/index.php &&
    echo $'\nexec("rm -rf /var/www/{{project.domain}}/{{project.srcout}}/install && sed -i \'$ d\' /var/www/{{project.domain}}/{{project.srcout}}/admin/index.php");' >> {{project.srcout}}/admin/index.php &&
    echo $'\n<script>history.pushState({}, null, "/"); $(".alert-danger button").trigger("click");</script>' >> {{project.srcout}}/install/view/template/install/step_4.tpl

fi

if [ "$SSL" = "yes" ]; then

    # Configuro el servidor seguro.

    echo ''

else

    # Elimino la configuración segura.
    
    echo ''

fi

echo "Include /etc/phpmyadmin/apache.conf" >> /etc/apache2/apache2.conf &&

echo 'end' > /var/www/html/gorilla_status.txt &&

a2enmod rewrite &&
a2ensite {{project.domain}} && 
sudo a2dissite 000-default.conf && 
a2enconf php5-fpm && 
service php5-fpm restart && 
service apache2 restart &&
service memcached restart

